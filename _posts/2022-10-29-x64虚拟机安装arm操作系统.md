---
layout: post
title: "build arm os on x64 os"
date: 2022-10-29
excerpt: "how to build arm os on x64 os."
tags:
- x64
- arm
- qemu
- virt
comments: false
---


# VMware 安装 Ubuntu16.04 虚拟机

## 下载 desktop 操作系统并安装

https://releases.ubuntu.com/16.04/ubuntu-16.04.7-desktop-amd64.iso

```shell
sudo apt install -fy vim net-tools
ifconfig -a
# 设置静态 IP
sudo vim /etc/network/interfaces
# 刷新 IP
sudo ip addr flush ens33
sudo systemctl restart networking
sudo reboot
```

- /etc/network/interfaces

```
auto ens33
iface ens33 inet static
address 192.168.1.102
netmask 255.255.255.0
gateway 192.168.1.1
dns-nameserver 114.114.114.114
```

## 安装 qemu-system-aarch64

```shell
ping -c 5 baidu.com
sudo apt install -fy openssh-server
sudo ufw allow ssh
sudo apt install -fy screenfetch
screenfetch
sudo apt install -fy qemu-system-arm
```

## 创建虚拟机工作目录，将虚拟机启动需要的文件都放在该目录下

```shell
mkdir qemu_system
cd qemu_system
```

## 创建虚拟硬盘

```shell
qemu-img create -f qcow2 ubuntu16.04-arm64.img 80g
```

## 下载 UEFI 固件

下载地址：http://releases.linaro.org/components/kernel/uefi-linaro/16.02/release/qemu64/QEMU_EFI.fd

## 下载 arm 操作系统

http://cdimage.ubuntu.com/releases/16.04/release/ubuntu-16.04.7-server-arm64.iso

## 虚拟机创建

```shell
qemu-system-aarch64 -m 2048 -cpu cortex-a57 -smp 2 -M virt -bios QEMU_EFI.fd -nographic -drive if=none,file=ubuntu-16.04.7-server-arm64.iso,id=cdrom,media=cdrom -device virtio-scsi-device -device scsi-cd,drive=cdrom -drive if=none,file=ubuntu16.04-arm64.img,id=hd0 -device virtio-blk-device,drive=hd0
```

## 设置桥接网络

```shell
sudo apt install -fy bridge-utils
sudo apt install -fy uml-utilities
sudo vim /etc/network/interfaces
sudo mv /etc/qemu-ifup /etc/qemu-ifup.bak
sudo vim /etc/qemu-ifup
sudo chmod +x /etc/qemu-ifup
sudo mv /etc/qemu-ifdown /etc/qemu-ifdown.bak
sudo vim /etc/qemu-ifdown
sudo chmod +x /etc/qemu-ifdown
```

- /etc/network/interfaces

```
auto br0
iface br0 inet static
bridge_ports ens33
bridge_stp off
bridge_fd 0
bridge_maxwait 0
address 192.168.1.102
netmask 255.255.255.0
gateway 192.168.1.1
dns-nameserver 114.114.114.114
```

- /etc/qemu-ifup

```
#!/bin/sh
switch=br0
echo sudo tunctl -u $(id -un) -t $1
sudo tunctl -u $(id -un) -t $1
echo sudo ifconfig $1 0.0.0.0 promisc up
sudo ifconfig $1 0.0.0.0 promisc up
echo sudo brctl addif ${switch} $1
sudo brctl addif ${switch} $1
echo brctl show
brctl show
# sudo ifconfig ${switch} 192.168.1.102
```

- /etc/qemu-ifdown

```
#!/bin/sh
switch=br0
echo sudo brctl delif ${switch} $1
sudo brctl delif ${switch} $1
echo sudo tunctl -d $1
sudo tunctl -d $1
echo brctl show
brctl show
```

## 创建启动脚本

在 qemu_system 目录下新建 run.sh 文件

```shell
qemu-system-aarch64 -m 2048 -cpu cortex-a57 -smp 2 -M virt -bios QEMU_EFI.fd -nographic -device virtio-scsi-device -drive if=none,file=ubuntu16.04-arm64.img,id=hd0 -device virtio-blk-device,drive=hd0 -netdev type=tap,id=net0 -device virtio-net-device,netdev=net0
```

## exit 手动指定 EFI 文件

## 设置 arm 系统静态 IP

```shell
# 设置静态 IP
sudo vi /etc/network/interfaces
auto eth0
iface eth0 inet static
address 192.168.1.103
netmask 255.255.255.0
gateway 192.168.1.1
dns-nameserver 114.114.114.114
# 刷新 IP
sudo ip addr flush eth0
sudo systemctl restart networking
ifconfig -a
sudo apt update
sudo apt install -fy openssh-server
sudo ufw allow ssh
sudo apt install -fy screenfetch
screenfetch
```

---

# 附上推荐配置

内存 8GB  
处理器 16（8*2）虚拟化引擎  
磁盘 200GB  
网络适配器 桥接模式（自动）  

3:02 2022/10/29

---

# 参考链接

https://blog.csdn.net/weixin_51760563/article/details/119935101  
https://blog.csdn.net/whb19881207/article/details/102456179
